---
title: Proxmox. Wheezy. pfSense. VLAN
layout: post
created_at: 29 мая 2011
tags: ['post']
kdpv: '/images/proxmox-logo.png'
intro: Поднимаем Proxmox, настраиваем VLAN, устанавливаем pfSense, пишем документацию на "тот" случай.
---
## Вступление
В серверной скопилось слабонагруженное железо - экономим железо - устанавливаем шлюз в виртуалку.

- Имеем два сервера:
	- почта
	- шлюз

Ни то, ни другое не нагружено, железо слабое, но громоздкое - жрёт электричество, занимает место, и вообще - патч-корды путаются под ногами.

- Чего есть:
	- недорогой 1U сервер Asus c 4 сетевыми картами, 4 винтами, псевдо-рейдом, и целым 1Г памяти
	- коммутатор, знающий про VLAN и TRUNK


- Чего надо:
	- установить систему виртуализации (бесплатную) на сервер
	- объединить все винты в рейд 10
	- объединить пару сетевых карт в trunk
	- завиртуализировать физические машины
	- написать документацию, что делать если админа переехал трамвай, а ничего не работает

## Proxmox
На нашем сервере 4 винчестера - делаем из них рейд 10 через установщик, благо на дебиане он прост как три копейки, устанавливаем стандартную систему без X и прочей дребедени. Разбиваем диск как душе угодно - я разбил стандартно - 2Г свап, 32Г на систему, хотя, вот уже две недели спустя, занято около 3Г - так что вполне можно было обойтись 8Г на все. Остальное отдаем на LVM - нарежем по мере надобности.

Далее, как по-написаному [здесь](http://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_Wheezy) - правим `/etc/apt/sources.list`, обновляем, устанавливаем ядро, перезагружаемся - работает. Проще не бывает.

Объединяем две сетевушки в транк `/etc/network/interfaces`
```
auto bond0
iface bond0 inet manual
        slaves eth0 eth1
        bond_mode 802.3ad
        bond_miimon 100

auto vmbr0
iface vmbr0 inet static
        bridge_ports bond0
        bridge_stp off
        bridge_fd 0
        address 192.168.1.2
        netmask 255.255.255.0
        network 192.168.0.0
        broadcast 192.168.1.255
        gateway 192.168.1.254
        dns-nameservers 192.168.1.254
        dns-search org.local
```
После чего в панели управления появляется наша сетевая карта - vmbr0, адрес матери(Proxmox) - 192.168.1.2

## Маршрутизатор
Первое - наметим на паре портов LinkAggreation, устанавливаем LACP, на, скажем, 23 и 24 порт - LAG0.

Второе - размечаем еще пару портов (у нас два провайдера) - скажем, `VLAN11` (первый Интернет-провайдер) - `1 и 2 порт UNTAGGED` и `VLAN12` (второй Интернет-провайдер) - `3 и 4 порт, тоже UNTAGGED`(далее, в документации, объясню зачем по два порта на каждого).

Для того чтобы эти разрозненные сети увидел наш сервер - добавлаяем на наш единый(23+24 порт) `LAG0` эти два VLAN-а - `11 и 12 TAGGED`. Наша локалка остается в `1(default) VLAN-e`.

## Виртуализация
### pfSense
Создаем первую виртуальную машину - добавляем 3 виртуальные сетевые карты - первая без VLAN tag, две следующие - с 11 и 12 меткой.
Памяти - 512М за глаза - и это при условии что мы туда поставим snort и агента zabbix.

Поскольку в качестве шлюза у нас стоит pfSense - сохраняем конфигурацию, устанавливаем в виртуалку pfSense, восстанавливаем конфигурацию, расписываем новые сетевые карты от старым (при восстановлении конфигурации pfSense покажет старые интерфейсы, новые, и спросит как это соотносится)

### Почтовый сервер
Поскольку старый почтовый сервер был в несколько нестандартной конфигурации, сделаем иначе. Создаем стандартную конфигурацию с одной сетевой картой и 256М памяти, загружаемся с любого linux livecd, копируем все файлы в виртуальную машину через `scp` или `rsync`, правим `/etc/fstab`

## Документация и т.д.
Настраиваем архивацию, расписание, ну вот это все.

Сохраняем все конфигурационные файлы рядом с документом
Документацию для примера приведу свою(коротко) - распечатываем, сохраняем на CD, подписываем `конфиг от 9 мая 2013`

PS: VLAN11 и 12 на два порта - это все таки излишки

PS2: На самом деле для pfSense можно было выдать одну сетевую карту, а на нем самом настроить те же самые VLAN, но решил сделать как сделал

PS3: Оставшееся место можно раздать под архивацию с другого сервера. Архивировать самого на себя моветон.

---

```
Все конфигурационные файлы – рядом с этим файлом

Сервер VM ProxMox
IP - 192.168.1.2, User: root, pass: [PASS]
Подключение – две сетевые карты в bond_LACP, порт GE25+G26
Архивы всех виртуальных машин каждый вторник и пятницу, в 00:15, не более 8 копий, на QNAP по NFS, папка bkp/dump, user/pass: [xxx/yyy]

VM 101-vm-mail (Linux)
IP: 192.168.1.3, User: root, pass: [PASS]
Одна виртуальная сетевая карта, привязка VLAN1(def)

VM 100-pfSense (FreeBSD)
IP: 192.168.1.254, User: admin, pass: [PASS]
Четыре виртуальных сетевые карты:
VLAN1(def) – локальная сеть(LAN), em0 – 192.168.1.254
VLAN12 – ISP Convex(WLAN1), em1 – 1.2.3.4/28, GW: 27
VLAN13 – ISP Beeline(WLAN2), em2 – 5.6.7.8/28, GW 27
VLAN14 – Wi-Fi(LAN_WIFI), em3 – 11.12.13.14/24
VLAN15 – IntraNET, em4 – no_IP
BRIDGE0 - LAN, IntraNET

Cisco SG200-26
IP: 192.168.1.4, User: cisco, pass: [PASS]
LAG1(LACP) – (GE12+GE24)1UP – связка с Cisco2
LAG2(LACP) – (GE25+GE26)1UP, 12T, 13T, 14T, 15T – на сервер ProxMox1
GE1, GE13		12UP	(ISP Convex)
GE2, GE14		13UP	(ISP Beeline)
GE3, GE15		14UP	(Wi-Fi)
GE4, GE16		15UP	(IntraNet)

QNAP
IP:192.168.1.5, User: xxx, pass: [ADMIN]

Если сломалась Cisco 
Настроить по примеру или восстановить из конфигурационного файла

Если сломан pfSense
1. Восстановить из архива
2. Установить новый, настроить по примеру

Если сломан ProxMox
1. pfSense установить либо:
- с 4 сетевыми картами, подключить все в 13,14,15 и 10 порт, настроить или восстановить конфиг по примеру
- c 1 сетевой картой, подключить в 25 или 26 порт, настроить или восстановить конфиг VLAN по примеру
```